name: Tests

on: [push, pull_request]

jobs:
    lint:
        name: "Ruff Linter"
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Python 3.11
              uses: actions/setup-python@v5
              with:
                  python-version: 3.11

            - name: Cache Poetry dependencies
              uses: actions/cache@v4
              with:
                  path: ~/.cache/pypoetry
                  key: ${{ runner.os }}-poetry-${{ hashFiles('**/poetry.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-poetry-

            - name: Install Poetry
              run: |
                  curl -sSL https://install.python-poetry.org | python3 -
                  export PATH="$HOME/.local/bin:$PATH"

            - name: Install dependencies
              run: |
                  poetry install

            - name: Run Ruff
              run: poetry run ruff check

    format:
        name: "Ruff Formatter"
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Python 3.11
              uses: actions/setup-python@v5
              with:
                  python-version: 3.11

            - name: Cache Poetry dependencies
              uses: actions/cache@v4
              with:
                  path: ~/.cache/pypoetry
                  key: ${{ runner.os }}-poetry-${{ hashFiles('**/poetry.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-poetry-

            - name: Install Poetry
              run: |
                  curl -sSL https://install.python-poetry.org | python3 -
                  export PATH="$HOME/.local/bin:$PATH"

            - name: Install dependencies
              run: |
                  poetry install

            - name: Run Ruff
              run: poetry run ruff format --check

    tests:
        strategy:
            matrix:
                python-version: ["3.11", "3.12"]
                django-version: ["4.2", "5.0"]

        name: "Pytest (Python: ${{ matrix.python-version }}, Django: ${{ matrix.django-version }})"
        runs-on: ubuntu-latest

        needs: [lint, format]

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Python ${{ matrix.python-version }}
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ matrix.python-version }}

            - name: Cache Poetry dependencies
              uses: actions/cache@v4
              with:
                  path: ~/.cache/pypoetry
                  key: ${{ runner.os }}-poetry-${{ hashFiles('**/poetry.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-poetry-

            - name: Install Poetry
              run: |
                  curl -sSL https://install.python-poetry.org | python3 -
                  export PATH="$HOME/.local/bin:$PATH"

            - name: Install dependencies
              run: |
                  poetry install

            - name: Run tests
              run: poetry run pytest
